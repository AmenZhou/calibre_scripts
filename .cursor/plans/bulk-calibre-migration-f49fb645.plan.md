<!-- f49fb645-80e0-4e41-963f-ed1ed12c3780 7dbf1926-6aac-43bd-a213-a636e5aa684c -->
# Move MyBookshelf2 Database to External Drive + Implement Symlinks for Books

## Overview

1. Move PostgreSQL database to external drive to save space
2. Implement symlink support so MyBookshelf2 uses Calibre library files directly (no copying)
3. This saves ~1.6-4 TB of disk space by avoiding file duplication

## Current Status

- Database location: `/var/lib/docker/volumes/mybookshelf2_db/_data` (Docker volume, 77 MB)
- Books location: `/var/lib/docker/volumes/mybookshelf2_data/_data/books` (Docker volume)
- Calibre library: `/media/haimengzhou/78613a5d-17be-413e-8691-908154970815/calibre library`
- External drive: 7.2 TB free (sufficient for DB + Calibre library)

## Space Savings

- Without symlinks: Need 2 TB (1.6 TB books + 371 GB DB) - would duplicate Calibre files
- With symlinks: Need ~371 GB (DB only) - books use Calibre library directly
- Savings: ~1.6-4 TB of disk space

## Steps

### Part 1: Move Database to External Drive

1. **Create directories on external drive**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Create: `/media/haimengzhou/78613a5d-17be-413e-8691-908154970815/mybookshelf2_db`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Create: `/media/haimengzhou/78613a5d-17be-413e-8691-908154970815/mybookshelf2_data` (for uploads, thumbs, converted)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Set proper permissions

2. **Stop MyBookshelf2 services**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `cd /home/haimengzhou/calibre_automation_scripts/mybookshelf2_setup`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `docker-compose down`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Ensure clean shutdown

3. **Backup and move database**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Backup current database using `pg_dump`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Copy database data from Docker volume to external drive
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Preserve permissions (postgres user, UID 999)

4. **Update docker-compose.yml for database**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Change `mybookshelf2_db` volume to bind mount:
     ```yaml
     volumes:
       - /media/haimengzhou/78613a5d-17be-413e-8691-908154970815/mybookshelf2_db:/var/lib/postgresql/data
     ```


### Part 2: Implement Symlink Support

5. **Mount Calibre library to container**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Add Calibre library as bind mount in docker-compose.yml:
     ```yaml
     volumes:
       - /media/haimengzhou/78613a5d-17be-413e-8691-908154970815/calibre library:/calibre_library:ro
     ```

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Add to both `app` and `backend` services

6. **Modify MyBookshelf2 logic.py to support symlinks**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Update `create_new_location()` function in `mybookshelf2/app/logic.py`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Add parameter `use_symlink=False` option
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - When `use_symlink=True`, create symlink instead of copying:
     ```python
     if use_symlink and os.path.exists(source_file):
         os.symlink(source_file, os.path.join(base_dir, new_location))
     else:
         shutil.copy(new_file, os.path.join(base_dir, new_location))
     ```


7. **Update migration script for symlink mode**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Modify `bulk_migrate_calibre.py`:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Add `--use-symlinks` flag
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - When enabled:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Skip file conversion (use original format from Calibre)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Find original file in Calibre library (EPUB, FB2, MOBI, PDF, etc.)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Create symlink in MyBookshelf2 structure pointing to Calibre file
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Pass symlink path to upload command
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Update `prepare_file_for_upload()` to skip conversion when `--use-symlinks` is enabled
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Update `upload_file()` to create symlinks in MyBookshelf2 directory structure
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Remove `convert_fb2_to_epub()` call when in symlink mode

8. **Handle directory structure mapping**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - MyBookshelf2 expects: `Author/Title(Language)/Author - Title.ext`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Calibre uses: `Author/Title/format/file.ext`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Migration script must:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Use original file format from Calibre (no conversion)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Create MyBookshelf2 directory structure
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Create symlink from MyBookshelf2 location to Calibre file location
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Store symlink path in database (MyBookshelf2 will read from it)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Note: Non-EPUB files (FB2, MOBI, PDF) will be downloadable but not readable in browser

9. **Update API/Logic to handle symlinks**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Ensure `read_source()` and `download()` functions work with symlinks
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Test that EPUB.js can read from symlinked files
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Verify file serving works correctly

10. **Update docker-compose.yml for books directory**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Change `mybookshelf2_data` to bind mount:
      ```yaml
      volumes:
        - /media/haimengzhou/78613a5d-17be-413e-8691-908154970815/mybookshelf2_data:/data
        - /media/haimengzhou/78613a5d-17be-413e-8691-908154970815/calibre library:/calibre_library:ro
      ```


11. **Test symlink functionality**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Run test migration with `--use-symlinks` flag
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Verify books can be read through symlinks
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Test web reader functionality
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Verify database records point to correct symlink paths

12. **Start services and verify**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `docker-compose up -d`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Verify database is accessible
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Verify books can be read
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Test full migration with symlinks

## Files to Modify

1. **docker-compose.yml**:

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Change database volume to bind mount
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Change mybookshelf2_data to bind mount  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Add Calibre library as read-only mount

2. **mybookshelf2/app/logic.py**:

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Modify `create_new_location()` to support symlink option
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Ensure file operations work with symlinks

3. **bulk_migrate_calibre.py**:

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Add `--use-symlinks` parameter
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Implement symlink creation logic
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Map Calibre file structure to MyBookshelf2 structure
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Create symlinks instead of copying files

## Considerations

- **Symlink paths**: Must use absolute paths or paths relative to container mount point
- **File conversion**: FB2 files still need conversion to EPUB, but converted file can be temporary
- **Directory structure**: Migration script must create MyBookshelf2 directory structure with symlinks
- **Permissions**: Symlinks must be readable by MyBookshelf2 container user
- **Calibre library stability**: If Calibre library path changes, symlinks will break
- **Performance**: Reading through symlinks should have minimal performance impact
- **Backup**: Symlinks are just pointers - backup Calibre library, not the symlinks

## Benefits

- **Massive space savings**: ~1.6-4 TB saved by not duplicating files
- **Single source of truth**: Calibre library remains the master copy
- **Faster migration**: No file copying, just symlink creation
- **Easier management**: Update Calibre library, MyBookshelf2 automatically sees changes (if files are updated in place)

### To-dos

- [ ] Modify bulk_migrate_calibre.py to use CLI (subprocess) instead of REST API for metadata processing
- [ ] Test FB2 to EPUB conversion in migration script with a small batch
- [ ] Test EPUB file upload and processing via fixed migration script
- [ ] Test EPUB reader functionality in web UI - verify loading, navigation, and settings
- [ ] Test reading converted FB2 files (now EPUB) in the reader
- [ ] Verify all reader features: TOC, navigation controls, settings panel, progress tracking